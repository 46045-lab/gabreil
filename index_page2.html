<!DOCTYPE html>
<html>

<style>
body {
  font-family: Arial;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.container {
  display: grid;
  grid-template-columns: 1fr; /*1 row type shi */
  gap: 15px;
  width: 750px;
}


button {
  padding: 18px;
  font-size: 18px;
  width: 100%;
}


.full {
  background: #ccc;
}
</style>
</head>
    <title>Selection page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<body style="background-color:lightgreen">

  <form id="sendForm"
      action="https://script.google.com/macros/s/AKfycbz9ERVWyEpcHVgeuoTw59gtrl21km7HzwQFyfKyjl4CJj6hfTKJHj65f6aIo0q7lgzE/exec"
      method="POST"
      style="display:none;">

  <input name="name">
  <input name="sur">
  <input name="nick">
  <input name="id">
  <input name="clazz">
  <input name="classNum">
  <input name="instrument">
</form>

<div class="container">
  <button onclick="choose('Welfare Division')" id="Welfare Division"></button>
  <button onclick="choose('Equipment & Instrument Division')" id="Equipment & Instrument Division"></button>
  <button onclick="choose('Public Relation')" id="Public Relation"></button>
  <button onclick="choose('Human Resources')" id="Human Resources"></button>
</div>







<script>

const EXEC_URL = "https://script.google.com/macros/s/AKfycbyBPqwlIQyKxKsqftLyp16173LtY2p09xg_pnVaY30rezkVOmb4g5gI2bYzc4IL80m0/exec";
const OPTIONS = [
  "Welfare Division",
  "Equipment & Instrument Division",
  "Public Relation",
  "Human Resources"
];
const MAX = 15;


// ❌ ถ้าเคยเลือกแล้ว → ไปหน้า 3 ทันที
if (localStorage.getItem("submitted") === "yes") {
  location.href = "index_page3.html";
}



function render() {
  fetch(EXEC_URL + "?action=getCounts")
    .then(res => res.json())
    .then(counts => {
      OPTIONS.forEach(opt => {
        const used = Number(counts[opt] || 0);
        const left = MAX - used;
        const btn = document.getElementById(opt);

        if (left <= 0) {
          btn.textContent = opt + " (FULL)";
          btn.disabled = true;
          btn.classList.add("full");
        } else {
          btn.textContent = opt + ` (${left} left)`;
          btn.disabled = false;
        }
      });
    });
}


// init counter

function choose(opt) {
  fetch(EXEC_URL + "?action=choose&option=" + encodeURIComponent(opt))
    .then(res => res.text())
    .then(result => {
      if (result === "FULL") {
        alert("This option is full");
        render();
      } else {
        sendToGoogleSheet(opt);
      }
    });
}



function HARD_RESET() {
  if (!confirm("RESET ALL COUNTS AND USERS?")) return;

  // 1️⃣ reset server counter
  fetch(EXEC_URL + "?action=reset")
    .then(res => res.text())
    .then(msg => {
      console.log(msg);

      // 2️⃣ reset local machine
      localStorage.clear();

      alert("RESET COMPLETE");
      location.reload();
    })
    .catch(err => {
      console.error(err);
      alert("RESET FAILED");
    });
}





function sendToGoogleSheet(choice) {
  const user = JSON.parse(localStorage.getItem("userInfo"));

  fetch(EXEC_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      name: user.name,
      sur: user.sur,
      nick: user.nick,
      id: user.id,
      clazz: user.clazz,
      classNum: user.classNum,
      instrument: user.instrument,
      choice: choice
    })
  });

  fetch(EXEC_URL + "?action=choose&option=" + encodeURIComponent(choice))
  .then(res => res.text())
  .then(res => {
    if (res === "OK") {
      localStorage.setItem("submitted", "yes");
      location.href = "index_page3.html";
    } else {
      alert("This option is FULL");
    }
  });

}




render();
</script>


</body>
</html>
